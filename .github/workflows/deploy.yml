name: Clean and Deploy
on:
  workflow_dispatch:
    inputs:
      zip_file:
        description: 'Zip file to extract'
        required: true
        default: 'project.zip'

permissions:
  contents: write
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean repository (keep README.md and CNAME)
        run: |
          echo "ğŸ§¹ Repository temizleniyor..."

          # README.md ve CNAME hariÃ§ tÃ¼m dosyalarÄ± sil
          find . -maxdepth 1 -type f ! -name 'README.md' ! -name 'CNAME' ! -name '.gitignore' ! -path './.git*' -delete

          # BoÅŸ olmayan klasÃ¶rleri sil (git klasÃ¶rÃ¼ hariÃ§)
          for dir in */; do
            if [ "$dir" != ".git/" ] && [ "$dir" != ".github/" ]; then
              echo "ğŸ—‘ï¸ KlasÃ¶r siliniyor: $dir"
              rm -rf "$dir"
            fi
          done

          echo "âœ… Repository temizlendi"

      - name: Extract project files
        run: |
          ZIP_FILE="${{ github.event.inputs.zip_file }}"
          echo "ğŸ“¦ Zip dosyasÄ± Ã§Ä±karÄ±lÄ±yor: $ZIP_FILE"

          # Zip dosyasÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
          if [ ! -f "$ZIP_FILE" ]; then
            echo "âŒ Zip dosyasÄ± bulunamadÄ±: $ZIP_FILE"

            # Mevcut zip dosyalarÄ±nÄ± listele
            echo "ğŸ“‹ Mevcut dosyalar:"
            ls -la *.zip 2>/dev/null || echo "Zip dosyasÄ± bulunamadÄ±"

            # En yeni zip dosyasÄ±nÄ± bul
            ZIP_FILE=$(ls -t *.zip 2>/dev/null | head -n1)
            if [ -z "$ZIP_FILE" ]; then
              echo "âŒ HiÃ§ zip dosyasÄ± bulunamadÄ±!"
              exit 1
            fi
            echo "âœ… KullanÄ±lacak zip: $ZIP_FILE"
          fi

          # Zip'i Ã§Ä±kar
          echo "ğŸ“‚ Zip iÃ§eriÄŸi Ã§Ä±karÄ±lÄ±yor..."
          unzip -q "$ZIP_FILE" || {
            echo "âŒ Zip Ã§Ä±karma hatasÄ±"
            exit 1
          }

          # Zip dosyasÄ±nÄ± sil
          rm "$ZIP_FILE"
          echo "âœ… Zip dosyasÄ± silindi: $ZIP_FILE"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # DeÄŸiÅŸiklikleri ekle
          git add .

          # Commit yap (deÄŸiÅŸiklik varsa)
          if git diff --staged --quiet; then
            echo "ğŸ“ DeÄŸiÅŸiklik yok, commit atlandÄ±"
          else
            git commit -m "ğŸš€ Proje dosyalarÄ± gÃ¼ncellendi"
            git push
            echo "âœ… DeÄŸiÅŸiklikler push edildi"
          fi